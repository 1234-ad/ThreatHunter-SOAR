{
  "playbook_id": "malware_incident_response_v2",
  "name": "Advanced Malware Incident Response",
  "version": "2.0",
  "description": "Comprehensive automated response playbook for malware incidents with advanced containment and eradication procedures",
  "author": "ThreatHunter-SOAR Team",
  "created_date": "2024-01-15",
  "last_modified": "2024-01-15",
  "severity_levels": ["HIGH", "CRITICAL"],
  "trigger_conditions": [
    {
      "condition_type": "threat_type",
      "values": ["malware", "trojan", "ransomware", "backdoor"]
    },
    {
      "condition_type": "severity",
      "values": ["high", "critical"]
    },
    {
      "condition_type": "confidence",
      "operator": ">=",
      "value": 0.7
    }
  ],
  "variables": {
    "isolation_timeout": "2h",
    "evidence_retention": "90d",
    "notification_channels": ["email", "slack", "sms"],
    "escalation_threshold": 30,
    "max_affected_systems": 10
  },
  "phases": [
    {
      "phase_id": "preparation",
      "name": "Preparation",
      "description": "Initial preparation and validation phase",
      "timeout": "5m",
      "actions": [
        {
          "action_id": "validate_incident",
          "name": "Validate Incident Data",
          "type": "validation",
          "description": "Validate incident data and ensure all required information is present",
          "timeout": "1m",
          "parameters": {
            "required_fields": ["threat_type", "affected_systems", "indicators", "severity"],
            "validation_rules": [
              "severity in ['high', 'critical']",
              "len(affected_systems) > 0",
              "len(indicators) > 0"
            ]
          },
          "on_success": "continue",
          "on_failure": "escalate_to_analyst"
        },
        {
          "action_id": "initialize_case",
          "name": "Initialize Case Management",
          "type": "case_management",
          "description": "Create case in SOAR platform and assign initial resources",
          "timeout": "2m",
          "parameters": {
            "case_template": "malware_incident",
            "priority": "high",
            "auto_assign": true,
            "create_war_room": true
          },
          "on_success": "continue",
          "on_failure": "manual_case_creation"
        },
        {
          "action_id": "threat_intel_enrichment",
          "name": "Threat Intelligence Enrichment",
          "type": "enrichment",
          "description": "Enrich IOCs with threat intelligence data",
          "timeout": "2m",
          "parameters": {
            "sources": ["virustotal", "abuseipdb", "otx", "misp"],
            "ioc_types": ["hash", "ip", "domain", "url"],
            "timeout_per_source": "30s"
          },
          "on_success": "continue",
          "on_failure": "continue_with_warning"
        }
      ]
    },
    {
      "phase_id": "identification",
      "name": "Identification & Analysis",
      "description": "Identify scope and analyze the malware incident",
      "timeout": "15m",
      "actions": [
        {
          "action_id": "system_inventory",
          "name": "Affected Systems Inventory",
          "type": "discovery",
          "description": "Identify all potentially affected systems",
          "timeout": "5m",
          "parameters": {
            "scan_methods": ["network_scan", "ad_query", "asset_db_lookup"],
            "search_criteria": {
              "ip_ranges": "incident.affected_networks",
              "time_window": "24h",
              "indicators": "incident.indicators"
            }
          },
          "outputs": ["affected_systems_list", "risk_assessment"],
          "on_success": "continue",
          "on_failure": "manual_inventory"
        },
        {
          "action_id": "malware_analysis",
          "name": "Automated Malware Analysis",
          "type": "analysis",
          "description": "Perform automated analysis of malware samples",
          "timeout": "10m",
          "parameters": {
            "analysis_engines": ["cuckoo", "joe_sandbox", "hybrid_analysis"],
            "analysis_timeout": "5m",
            "extract_iocs": true,
            "behavioral_analysis": true
          },
          "outputs": ["malware_family", "capabilities", "additional_iocs"],
          "on_success": "continue",
          "on_failure": "continue_with_warning"
        },
        {
          "action_id": "lateral_movement_check",
          "name": "Lateral Movement Detection",
          "type": "analysis",
          "description": "Check for signs of lateral movement",
          "timeout": "5m",
          "parameters": {
            "search_timeframe": "72h",
            "indicators": "incident.indicators + malware_analysis.additional_iocs",
            "search_scope": "network_wide",
            "techniques": ["smb_enumeration", "rdp_connections", "wmi_activity"]
          },
          "outputs": ["lateral_movement_detected", "compromised_accounts", "attack_path"],
          "on_success": "continue",
          "on_failure": "continue_with_warning"
        }
      ]
    },
    {
      "phase_id": "containment",
      "name": "Containment",
      "description": "Contain the malware incident to prevent further spread",
      "timeout": "20m",
      "actions": [
        {
          "action_id": "immediate_isolation",
          "name": "Immediate System Isolation",
          "type": "containment",
          "description": "Immediately isolate confirmed infected systems",
          "timeout": "5m",
          "priority": "critical",
          "parameters": {
            "isolation_method": "network_isolation",
            "preserve_evidence": true,
            "isolation_type": "quarantine_vlan",
            "systems": "incident.affected_systems"
          },
          "parallel_execution": true,
          "on_success": "continue",
          "on_failure": "escalate_immediately"
        },
        {
          "action_id": "block_iocs",
          "name": "Block Malicious Indicators",
          "type": "blocking",
          "description": "Block malicious IOCs across security infrastructure",
          "timeout": "10m",
          "parameters": {
            "devices": ["firewall", "proxy", "dns", "email_security"],
            "ioc_sources": ["incident.indicators", "malware_analysis.additional_iocs"],
            "block_duration": "24h",
            "create_signatures": true
          },
          "parallel_execution": true,
          "on_success": "continue",
          "on_failure": "manual_blocking_required"
        },
        {
          "action_id": "account_containment",
          "name": "Compromised Account Containment",
          "type": "containment",
          "description": "Contain compromised user accounts",
          "timeout": "5m",
          "parameters": {
            "accounts": "lateral_movement_check.compromised_accounts",
            "actions": ["disable_account", "reset_password", "revoke_tokens"],
            "preserve_evidence": true
          },
          "condition": "lateral_movement_check.compromised_accounts is not empty",
          "on_success": "continue",
          "on_failure": "manual_account_review"
        },
        {
          "action_id": "network_segmentation",
          "name": "Enhanced Network Segmentation",
          "type": "containment",
          "description": "Implement additional network segmentation",
          "timeout": "10m",
          "parameters": {
            "affected_segments": "incident.network_segments",
            "isolation_rules": [
              "block_inter_segment_communication",
              "allow_management_access",
              "log_all_attempts"
            ],
            "duration": "variables.isolation_timeout"
          },
          "on_success": "continue",
          "on_failure": "manual_segmentation"
        }
      ]
    },
    {
      "phase_id": "eradication",
      "name": "Eradication",
      "description": "Remove malware and eliminate root cause",
      "timeout": "30m",
      "actions": [
        {
          "action_id": "evidence_collection",
          "name": "Forensic Evidence Collection",
          "type": "collection",
          "description": "Collect forensic evidence before eradication",
          "timeout": "15m",
          "parameters": {
            "collection_types": ["memory_dump", "disk_image", "network_capture", "system_logs"],
            "systems": "incident.affected_systems",
            "retention_period": "variables.evidence_retention",
            "chain_of_custody": true
          },
          "parallel_execution": true,
          "on_success": "continue",
          "on_failure": "continue_with_warning"
        },
        {
          "action_id": "malware_removal",
          "name": "Automated Malware Removal",
          "type": "eradication",
          "description": "Remove malware using automated tools",
          "timeout": "20m",
          "parameters": {
            "removal_tools": ["antivirus", "anti_malware", "custom_scripts"],
            "scan_types": ["full_system", "boot_sector", "registry"],
            "quarantine_threats": true,
            "systems": "incident.affected_systems"
          },
          "depends_on": ["evidence_collection"],
          "parallel_execution": true,
          "on_success": "continue",
          "on_failure": "manual_removal_required"
        },
        {
          "action_id": "persistence_removal",
          "name": "Remove Persistence Mechanisms",
          "type": "eradication",
          "description": "Remove malware persistence mechanisms",
          "timeout": "10m",
          "parameters": {
            "persistence_types": [
              "registry_run_keys",
              "scheduled_tasks",
              "services",
              "startup_folders",
              "wmi_subscriptions"
            ],
            "indicators": "malware_analysis.persistence_indicators",
            "systems": "incident.affected_systems"
          },
          "depends_on": ["evidence_collection"],
          "on_success": "continue",
          "on_failure": "manual_persistence_removal"
        },
        {
          "action_id": "vulnerability_patching",
          "name": "Patch Exploited Vulnerabilities",
          "type": "eradication",
          "description": "Patch vulnerabilities exploited by malware",
          "timeout": "15m",
          "parameters": {
            "vulnerability_sources": ["malware_analysis.exploited_vulns", "threat_intel.cve_list"],
            "patch_priority": "critical",
            "systems": "incident.affected_systems",
            "test_patches": false,
            "emergency_patching": true
          },
          "on_success": "continue",
          "on_failure": "schedule_maintenance_window"
        }
      ]
    },
    {
      "phase_id": "recovery",
      "name": "Recovery",
      "description": "Restore systems and services to normal operation",
      "timeout": "45m",
      "actions": [
        {
          "action_id": "system_validation",
          "name": "System Integrity Validation",
          "type": "validation",
          "description": "Validate system integrity before restoration",
          "timeout": "20m",
          "parameters": {
            "validation_checks": [
              "antivirus_scan",
              "integrity_check",
              "configuration_validation",
              "performance_baseline"
            ],
            "systems": "incident.affected_systems",
            "baseline_comparison": true
          },
          "on_success": "continue",
          "on_failure": "rebuild_required"
        },
        {
          "action_id": "gradual_restoration",
          "name": "Gradual System Restoration",
          "type": "recovery",
          "description": "Gradually restore systems to production",
          "timeout": "30m",
          "parameters": {
            "restoration_phases": [
              "network_connectivity",
              "basic_services",
              "user_access",
              "full_functionality"
            ],
            "monitoring_period": "24h",
            "rollback_triggers": ["malware_detection", "performance_degradation"],
            "systems": "incident.affected_systems"
          },
          "depends_on": ["system_validation"],
          "on_success": "continue",
          "on_failure": "rollback_restoration"
        },
        {
          "action_id": "enhanced_monitoring",
          "name": "Deploy Enhanced Monitoring",
          "type": "monitoring",
          "description": "Deploy enhanced monitoring for recovered systems",
          "timeout": "10m",
          "parameters": {
            "monitoring_duration": "30d",
            "monitoring_types": [
              "behavioral_analysis",
              "network_traffic",
              "file_integrity",
              "process_monitoring"
            ],
            "alert_sensitivity": "high",
            "systems": "incident.affected_systems"
          },
          "on_success": "continue",
          "on_failure": "manual_monitoring_setup"
        }
      ]
    },
    {
      "phase_id": "lessons_learned",
      "name": "Lessons Learned",
      "description": "Document lessons learned and improve defenses",
      "timeout": "15m",
      "actions": [
        {
          "action_id": "incident_documentation",
          "name": "Complete Incident Documentation",
          "type": "documentation",
          "description": "Generate comprehensive incident report",
          "timeout": "10m",
          "parameters": {
            "report_sections": [
              "executive_summary",
              "timeline",
              "impact_assessment",
              "root_cause_analysis",
              "lessons_learned",
              "recommendations"
            ],
            "include_evidence": true,
            "stakeholder_distribution": ["ciso", "it_management", "legal"]
          },
          "on_success": "continue",
          "on_failure": "manual_documentation"
        },
        {
          "action_id": "defense_improvements",
          "name": "Implement Defense Improvements",
          "type": "improvement",
          "description": "Implement identified security improvements",
          "timeout": "5m",
          "parameters": {
            "improvement_types": [
              "detection_rules",
              "prevention_controls",
              "monitoring_enhancements",
              "training_updates"
            ],
            "priority": "high",
            "implementation_timeline": "30d"
          },
          "on_success": "continue",
          "on_failure": "schedule_improvements"
        }
      ]
    }
  ],
  "notifications": [
    {
      "trigger": "playbook_start",
      "recipients": ["soc_team", "incident_commander"],
      "channels": ["email", "slack"],
      "template": "malware_incident_started",
      "urgency": "high"
    },
    {
      "trigger": "containment_complete",
      "recipients": ["ciso", "it_management"],
      "channels": ["email"],
      "template": "containment_notification",
      "urgency": "medium"
    },
    {
      "trigger": "recovery_complete",
      "recipients": ["all_stakeholders"],
      "channels": ["email", "dashboard"],
      "template": "incident_resolved",
      "urgency": "low"
    },
    {
      "trigger": "action_failure",
      "recipients": ["soc_lead", "incident_commander"],
      "channels": ["email", "sms"],
      "template": "action_failure_alert",
      "urgency": "critical"
    }
  ],
  "escalation_rules": [
    {
      "condition": "phase_timeout",
      "action": "escalate_to_senior_analyst",
      "notification": true
    },
    {
      "condition": "critical_action_failure",
      "action": "escalate_to_incident_commander",
      "notification": true
    },
    {
      "condition": "affected_systems > variables.max_affected_systems",
      "action": "activate_crisis_team",
      "notification": true
    }
  ],
  "success_criteria": [
    "all_malware_removed",
    "systems_restored",
    "no_lateral_movement_detected",
    "vulnerabilities_patched",
    "monitoring_deployed"
  ],
  "rollback_procedures": [
    {
      "trigger": "restoration_failure",
      "actions": ["isolate_system", "restore_from_backup", "notify_stakeholders"]
    },
    {
      "trigger": "reinfection_detected",
      "actions": ["immediate_isolation", "restart_eradication_phase"]
    }
  ],
  "metrics": [
    "time_to_containment",
    "time_to_eradication",
    "time_to_recovery",
    "systems_affected",
    "data_compromised",
    "business_impact_duration"
  ],
  "compliance_requirements": [
    "evidence_preservation",
    "chain_of_custody",
    "incident_reporting",
    "stakeholder_notification"
  ]
}